name: Core Tests

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]

jobs:
  test-algorithm:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y gcc make

    - name: Build and test k-means
      run: |
        cd core/tests
        make clean
        make test

    - name: Check memory footprint
      run: |
        cd core/tests
        ./test_kmeans 2>&1 | grep "Model size"
        SIZE=$(./test_kmeans 2>&1 | grep "Model size" | awk '{print $3}')
        if [ "$SIZE" -gt 102400 ]; then
          echo "ERROR: Model size $SIZE exceeds 100KB"
          exit 1
        fi

  compile-arduino:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Check config template exists
      run: |
        if [ ! -f "core/config.template.h" ]; then
          echo "ERROR: config.template.h missing"
          exit 1
        fi

    - name: Create config.h for CI
      run: |
        cd core
        cp config.template.h config.h
        sed -i 's/YOUR_WIFI_SSID/test_ssid/g' config.h
        sed -i 's/YOUR_WIFI_PASSWORD/test_pass/g' config.h

    - name: Cache Arduino CLI
      uses: actions/cache@v3
      with:
        path: bin
        key: ${{ runner.os }}-arduino-cli

    - name: Install Arduino CLI
      run: |
        if [ ! -f "bin/arduino-cli" ]; then
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
        fi

    - name: Add to PATH
      run: echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

    - name: Cache Arduino packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.arduino15/packages
          ~/Arduino/libraries
        key: ${{ runner.os }}-arduino-packages-v2

    - name: Install ESP32 core
      run: |
        arduino-cli config init --overwrite
        arduino-cli config add board_manager.additional_urls https://espressif.github.io/arduino-esp32/package_esp32_index.json
        arduino-cli core update-index
        arduino-cli core install esp32:esp32

    - name: Install RP2040 core
      run: |
        arduino-cli config add board_manager.additional_urls https://github.com/earlephilhower/arduino-pico/releases/download/global/package_rp2040_index.json
        arduino-cli core update-index
        arduino-cli core install rp2040:rp2040

    - name: Install libraries
      run: |
        arduino-cli lib install "PubSubClient"
        arduino-cli lib install "ArduinoJson"
        arduino-cli lib install "Adafruit MPU6050"
        arduino-cli lib install "Adafruit ADXL345"
        arduino-cli lib install "Adafruit Unified Sensor"

    - name: Compile for ESP32
      run: arduino-cli compile --fqbn esp32:esp32:esp32 core/

    - name: Compile for RP2040 Pico 2W
      run: arduino-cli compile --fqbn rp2040:rp2040:rpipico2w core/