name: Core Algorithm Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'core/**'
      - '.github/workflows/test-core.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'core/**'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Compile tests
      run: |
        cd core
        gcc -o tests/test_kmeans tests/test_kmeans.c streaming_kmeans.c -lm -Wall -Wextra -Werror

    - name: Compile HITL tests
      run: |
        cd core
        gcc -o tests/test_hitl tests/test_hitl.c streaming_kmeans.c -lm -Wall -Wextra -Werror

    - name: Run all tests
      run: |
        cd core
        echo "=== Core Algorithm ==="
        ./tests/test_kmeans
        echo ""
        echo "=== HITL Corrections ==="
        ./tests/test_hitl

    - name: Generate summary
      if: always()
      run: |
        cd core
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "### Core Algorithm" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        ./tests/test_kmeans >> $GITHUB_STEP_SUMMARY 2>&1 || true
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### HITL Corrections" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        ./tests/test_hitl >> $GITHUB_STEP_SUMMARY 2>&1 || true
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Binary sizes:** kmeans=$(stat -c%s test_kmeans)B, hitl=$(stat -c%s test_hitl)B" >> $GITHUB_STEP_SUMMARY